!function(){angular.module("kiboRtc.config",[]).value("kiboRtc.config",{debug:!0}),angular.module("kiboRtc.directives",[]),angular.module("kiboRtc.filters",[]),angular.module("kiboRtc.services",[]),angular.module("kiboRtc",["kiboRtc.config","kiboRtc.directives","kiboRtc.filters","kiboRtc.services"])}(),angular.module("kiboRtc.services").factory("FileTransfer",function(e,n,t,a,o,r){function i(e){e.candidate&&r.sendMessageForDataChannel({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})}function c(e){g.setLocalDescription(e),r.sendMessageForDataChannel(e)}function s(e){console.log("createOffer() error: ",e)}function d(n){R=n.data,e.$broadcast("dataChannelMessageReceived")}function u(){m.readyState}function l(e){m=e.channel,m.onmessage=d,m.onopen=f,m.onclose=f}function f(){m.readyState}var m,g,R,p=!1,C=!1;return{createPeerConnection:function(e){try{g=new RTCPeerConnection(n,{optional:[]}),g.onicecandidate=i;try{try{m=g.createDataChannel("sendDataChannel",{reliable:!0})}catch(t){console.log("UNRELIABLE DATA CHANNEL"),m=g.createDataChannel("sendDataChannel",{reliable:!1})}m.onmessage=d,trace("Created send data channel")}catch(t){return e(t),trace("createDataChannel() failed with exception: "+t.message),void 0}m.onopen=u,m.onclose=u,g.ondatachannel=l,e(null)}catch(t){e(t),console.log("Failed to create PeerConnection, exception: "+t.message)}},sendData:function(e){m.send(e)},createAndSendOffer:function(){g.createOffer(c,s)},createAndSendAnswer:function(){g.createAnswer(c,function(e){console.log(e)},a)},setRemoteDescription:function(e){g.setRemoteDescription(new RTCSessionDescription(e))},addIceCandidate:function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});g.addIceCandidate(n)},endConnection:function(){C=!1,p=!1;try{g.close()}catch(e){}},getMessage:function(){return R},setInitiator:function(e){p=e},getInitiator:function(){return p},setIsStarted:function(e){C=e},getIsStarted:function(){return C},sanitize:function(e){return e=e.toString(),e.replace(/[\<\>"'\/]/g,function(e){var n={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return n[e]})},bootAlert:function(e){alert(e),console.log("Boot_alert: ",e)},FSerrorHandler:function(e){var n="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:n="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:n="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:n="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:n="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:n="INVALID_STATE_ERR";break;default:n="Unknown Error"}console.error("Error: "+n)},getReadableFileSizeString:function(e){var n=-1,t=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do e/=1024,n++;while(e>1024);return Math.max(e,.1).toFixed(1)+t[n]},_arrayBufferToBase64:function(e){for(var n="",t=new Uint8Array(e),a=t.byteLength,o=0;a>o;o++)n+=String.fromCharCode(t[o]);return window.btoa(n)},getChunkSize:function(){return 16e3}}}),angular.module("kiboRtc.services").factory("RTCConference",function(e,n,t,a,o,r){function i(e){e.candidate&&r.sendMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})}function c(e){T.setLocalDescription(e),r.sendMessage(e)}function s(e){console.log("createOffer() error: ",e)}function d(e){remoteStream?(D.src=URL.createObjectURL(e.stream),S=e.stream,screenShared=!0):(remoteVideo.src=URL.createObjectURL(e.stream),remoteStream=e.stream)}function u(e){console.log(e),"undefined"!=typeof S?(S.stop(),S=null,screenShared=!1):(S.stop(),remoteStream.stop(),S=null,remoteStream=null)}function l(n){message=n.data,e.$broadcast("dataChannelMessageReceived")}function f(){k.readyState}function m(e){k=e.channel,k.onmessage=l,k.onopen=g,k.onclose=g}function g(){k.readyState}var R,p,C,S,h,b,I,v,D,y,L,E=0,A=4,M=!1,w=!1,k=new Array(A),T=new Array(A),U=!1;return{initialize:function(e,n,t,a,o,r,i){h=e,b=n,I=t,v=a,D=o,y=r,L=i},createPeerConnection:function(){try{T[E]=new RTCPeerConnection(n,{optional:[]}),T[E].onicecandidate=i,T[E].onaddstream=d,T[E].onremovestream=u;try{try{k[E]=T[E].createDataChannel("sendDataChannel",{reliable:!0})}catch(e){console.log("UNRELIABLE DATA CHANNEL"),k[E]=T[E].createDataChannel("sendDataChannel",{reliable:!1})}k[E].onmessage=l,trace("Created send data channel")}catch(e){alert("Failed to create data channel. You need Chrome M25 or later with RtpDataChannel enabled : "+e.message),trace("createDataChannel() failed with exception: "+e.message)}k[E].onopen=f,k[E].onclose=f,T[E].ondatachannel=m,T.addStream(p)}catch(e){return console.log("Failed to create PeerConnection, exception: "+e.message),alert("Cannot create RTCPeerConnection object."),void 0}},createAndSendOffer:function(){T[E].createOffer(c,s)},createAndSendAnswer:function(){T[E].createAnswer(c,function(e){console.log(e)},a)},setRemoteDescription:function(e){T.setRemoteDescription(new RTCSessionDescription(e))},addIceCandidate:function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});T.addIceCandidate(n)},captureUserMedia:function(e){getUserMedia(o,function(n){p=n,localVideo.src=URL.createObjectURL(n),e(null)},function(n){e(n)})},endConnection:function(){w=!1,M=!1,console.log(p),p&&p.stop(),C&&C.stop(),remoteStream&&(remoteStream.stop(),remoteVideo.src=null,remoteStream=null),S&&(S.stop(),D.src=null,S=null),console.log(p);try{T.close()}catch(e){}},initializeSignalling:function(e,n,t){r.initialize(e,n,t)},hideScreen:function(){C.stop(),T.removeStream(C)},addStreamForScreen:function(e){C=e,localVideoScreen.src=URL.createObjectURL(e),T.addStream(e)},getLocalStream:function(){return p},getScreenShared:function(){return screenShared},setInitiator:function(e){M=e},getInitiator:function(){return M},setIsStarted:function(e){w=e},getIsStarted:function(){return w},increasePCIndex:function(){E++},getPcIndex:function(){return E},setIsChannelReady:function(e){R=e},getIsChannelReady:function(){return R},setIJoinLate:function(e){U=e},getIJoinLate:function(){return U},stopLocalStream:function(){p.stop()}}}),angular.module("kiboRtc.services").factory("pc_config",function(){return{iceServers:[{url:"turn:cloudkibo@162.243.217.34:3478?transport=udp",username:"cloudkibo",credential:"cloudkibo"},{url:"stun:stun.l.google.com:19302",username:null,credential:null},{url:"stun:stun.anyfirewall.com:3478",username:null,credential:null},{url:"turn:turn.bistri.com:80?transport=udp",username:"homeo",credential:"homeo"},{url:"turn:turn.bistri.com:80?transport=tcp",username:"homeo",credential:"homeo"},{url:"turn:turn.anyfirewall.com:443?transport=tcp",username:"webrtc",credential:"webrtc"}]}}).factory("pc_constraints",function(){return{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]}}).factory("sdpConstraints",function(){return{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}).factory("video_constraints",function(){return{video:!0,audio:!1}}).factory("audio_constraints",function(){return{video:!1,audio:!0}}),angular.module("kiboRtc.services").factory("ScreenShare",function(e,n){function t(e){if("PermissionDeniedError"==e){if(r="PermissionDeniedError",o)return o("PermissionDeniedError");throw new Error("PermissionDeniedError")}"kiboconnection-extension-loaded"==e&&(r="desktop"),e.sourceId&&(i=e.sourceId,o&&o(e.sourceId))}var a,o,r,i,c={mandatory:{chromeMediaSource:r,maxWidth:1920,maxHeight:1080,minAspectRatio:1.77},optional:[]},s={audio:!1,video:c};return{initialize:function(){a=!!navigator.webkitGetUserMedia,r="screen",window.addEventListener("message",function(e){e.origin==window.location.origin&&t(e.data)})},getSourceId:function(e){if(!e)throw'"callback" parameter is mandatory.';o=e,n.postMessage("get-sourceId","*")},isChromeExtensionAvailable:function(e){e&&("desktop"==r&&e(!0),n.postMessage("are-you-there","*"),setTimeout(function(){"screen"==r?e(!1):(e(!0),c.mandatory.chromeMediaSource="desktop")},2e3))},screen_constraints:function(){return c},session:function(){return s},getChromeMediaSource:function(){return r},getSourceIdValue:function(){return i},setSourceIdInConstraints:function(){c.mandatory.chromeMediaSourceId=i,s.video=c}}}),angular.module("kiboRtc.services").factory("Signalling",function(e,n){var t,a,o;return{initialize:function(e,n,r){t=e,a=n,o=r},sendMessage:function(e){e={msg:e},e.room=o,e.to=t,e.username=a,n.emit("message",e)},sendMessageForDataChannel:function(e){e={msg:e},e.room=o,e.to=t,e.from=a,n.emit("messagefordatachannel",e)},sendMessageForMeeting:function(e){e={msg:e},e.room=o,e.username=a,n.emit("messageformeeting",e)},destroy:function(){t=null,a=null,o=null}}}),angular.module("kiboRtc.services").factory("WebRTC",function(e,n,t,a,o,r,i){function c(e){e.candidate&&i.sendMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})}function s(e){R.setLocalDescription(e),i.sendMessage(e)}function d(e){console.log("createOffer() error: ",e)}function u(n){n.stream.getAudioTracks().length&&(h.src=URL.createObjectURL(n.stream),y=n.stream),n.stream.getVideoTracks().length&&(D?(b.src=URL.createObjectURL(n.stream),L=n.stream,e.$broadcast("screenShared")):(S.src=URL.createObjectURL(n.stream),D=n.stream))}function l(n){console.log(n),"undefined"!=typeof L?(L.stop(),L=null,e.$broadcast("screenRemoved")):(L.stop(),D.stop(),L=null,D=null)}var f,m,g,R,p,C,S,h,b,I=!1,v=!1,D=null,y=null,L=null;return{initialize:function(e,n,t,a,o){p=e,C=n,S=t,h=a,b=o},createPeerConnection:function(){R=new RTCPeerConnection(n,{optional:[]}),R.onicecandidate=c,R.onaddstream=u,R.onremovestream=l,R.addStream(m),f&&R.addStream(f)},createAndSendOffer:function(){R.createOffer(s,d)},createAndSendAnswer:function(){R.createAnswer(s,function(e){console.log(e)},a)},setRemoteDescription:function(e){R.setRemoteDescription(new RTCSessionDescription(e))},addIceCandidate:function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});R.addIceCandidate(n)},captureUserMedia:function(e,n){var t;if("audio"==e)t=r;else{if("video"!=e)return n('Invalid stream type. Must be "audio" or "video"');t=o}getUserMedia(t,function(t){"audio"==e?m=t:"video"==e&&(f=t,p.src=URL.createObjectURL(t)),n(null)},function(e){n(e)})},endConnection:function(){v=!1,I=!1,f&&f.stop(),m&&m.stop(),g&&g.stop(),D&&(D.stop(),S.src=null,D=null),y&&(y.stop(),h.src=null,y=null),L&&(L.stop(),b.src=null,L=null);try{R.close()}catch(e){}},initializeSignalling:function(e,n,t){i.initialize(e,n,t)},hideScreen:function(){g.stop(),R.removeStream(g)},addStreamForScreen:function(e){g=e,C.src=URL.createObjectURL(e),R.addStream(e)},getLocalAudioStream:function(){return m},setInitiator:function(e){I=e},getInitiator:function(){return I},setIsStarted:function(e){v=e},getIsStarted:function(){return v}}});